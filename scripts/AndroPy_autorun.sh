#!/bin/bash

# Store the path to the directory in a variable
src_folder=$1
des_folder=$2

# Global variable
WORKING_USER=virus

echo "Source file: ${src_folder^^}"
echo "Destination file: ${des_folder^^}"

echo -e "\n\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
echo "@@ !!! VIRUS TOTAL API KEY ONLY HAS A QUOTAS IN A MINUS/DAY !!!@@"
echo -e "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\n"

read -p "Use default API key (hardcoded) [YES/NO]? " option

shopt -s nocasematch

if [[ $option =~ YES|Y ]] 
then 
  vt_api_key="a54d394ab2062917d31a22e60db6c43a3484aeefe423a0a842b49daaece136db"
elif [[ $option =~ NO|N ]]
then
  read -p "Your customized VirusTotal API key: " vt_api_key
else
  echo "Choice only match with 'yes(y)' or 'no(n)' !!!"
  exit 0
fi

# Use the built-in `readarray` command to store the list of files in an array
readarray -t files < <(find "$src_folder" -maxdepth 1 -type f)


echo "========== PREPROCESSING ==========="

# Create destination folder if it does not exist
if [[ -d "$des_folder" ]]
then
  echo "Destination folder found!!!"
else
  mkdir -p "$des_folder"
  echo ">>>>>>>> Create resulting folder successfully !!!"
fi


file_log="$des_folder/status_checker_$(date +'%Y-%m-%d_%H:%M:%S').log"

# Add an output checker file
if [[ -e "$des_folder/status_checker_$(date +'%Y-%m-%d_%H:%M:%S').log" ]]
then
  echo "[//////////////// FILE ANALYSIS PROCESS CHECKER ////////////////" > "$file_log"
else
  echo ">>>>>>>>> FILE LOG CREATED !!!"
  echo  "[//////////////// FILE ANALYSIS PROCESS CHECKER ////////////////" > "$file_log"
fi

# Create TEMP folder for each processing loop 
temp_path="/home/$WORKING_USER/Desktop/TEST_APK"
if [[ -d "$temp_path" ]] 
then
  echo "Destination folder found!!!"
  rm -dRf  $temp_path/*
  mkdir -p "$temp_path"
else
  mkdir -p "$temp_path"
  sudo chown -R $WORKING_USER:$WORKING_USER $temp_path
  echo ">>>>>>>> Create TEMP folder successfully !!!"
fi

# Make folder for destination path

mkdir -p $des_folder/DroidBox_outputs/
mkdir -p $des_folder/Dynamic/Droidbox/
mkdir -p $des_folder/Dynamic/Strace/
mkdir -p $des_folder/Features_files/
mkdir -p $des_folder/FlowDroid_outputs/
mkdir -p $des_folder/FlowDroid_processed/
mkdir -p $des_folder/samples/BW/
mkdir -p $des_folder/samples/MW/
mkdir -p $des_folder/invalid_apks/
mkdir -p $des_folder/VT_analysis/



# Loop from 0 to the length of the array


echo "============== START EVALUATE ================"

for i in $(seq 0 $((${#files[@]} - 1))); do

  # Clear the container stored in the system
  echo "Y" | docker system prune

  # Remove all output and start new files
  echo "REMOVING ALL OUTPUT (IF TRUE)..."
  
  

  rm -dRf  $temp_path/*

  
  cp "${files[i]}" "/home/$WORKING_USER/Desktop/TEST_APK"
  
  # Start AndroPy
  echo "PROCESSING WITH ANDROPY ... ${file[i]}"
  docker run --volume=$temp_path:/apks alexmyg/andropytool -s /apks/ -vt $vt_api_key -all

  # Check the condition
  if [[ -d  "$temp_path/DroidBox_outputs" && -d  "$temp_path/Dynamic" && -d  "$temp_path/Features_files" && -d  "$temp_path/FlowDroid_outputs" && -d  "$temp_path/FlowDroid_processed" && -d  "$temp_path/VT_analysis" ]]
  then
    if [[ -z $(ls -A "$temp_path/DroidBox_outputs") || -z $(ls -A "$temp_path/Dynamic") || -z $(ls -A "$temp_path/Features_files") || -z $(ls -A "$temp_path/FlowDroid_outputs") || -z $(ls -A "$temp_path/FlowDroid_processed") || -z $(ls -A "$temp_path/VT_analysis") ]]
    then 
      echo "${files[i]}: FAILED - Empty folder detected !!!" >> "$file_log"
    else
      echo "${files[i]}: SUCCESSFUL !!!" >> "$file_log"
      cp -f $temp_path/DroidBox_outputs/* $des_folder/DroidBox_outputs/
      cp -f $temp_path/Dynamic/Droidbox/* $des_folder/Dynamic/Droidbox/
      cp -f $temp_path/Dynamic/Strace/* $des_folder/Dynamic/Strace/
      cp -f $temp_path/Features_files/* $des_folder/Features_files/
      cp -f $temp_path/FlowDroid_outputs/* $des_folder/FlowDroid_outputs/
      cp -f $temp_path/FlowDroid_processed/* $des_folder/FlowDroid_processed/
      cp -f $temp_path/VT_analysis/* $des_folder/VT_analysis/
      cp -f $temp_path/samples/BW/* $des_folder/samples/BW/
      cp -f $temp_path/samples/MW/* $des_folder/samples/MW/
      cp -f $temp_path/invalid_apks/* $des_folder/invalid_apks/  
    fi
  else
    echo "${files[i]}: FAILED - No folder detected !!!" >> "$file_log"
  fi
   

done
echo "============== FINISH EVALUATE ================"
