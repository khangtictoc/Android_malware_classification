#!/bin/bash

# Store the path to the directory in a variable
src_folder=$1
des_folder=$2

echo "Source file: $src_folder"
echo "Destination file: $des_folder"


# Use the built-in `readarray` command to store the list of files in an array
readarray -t files < <(find "$src_folder" -maxdepth 1 -type f)


echo "========== PREPROCESSING ==========="

# Add an output checker file
if [[ -e result_checker ]]
then
  echo "" > result_checker
else
  touch result_checker
  echo  "" > result_checker
fi


# Make folder for destination path

mkdir -p $des_folder/DroidBox_outputs/
mkdir -p $des_folder/Dynamic/Droidbox/
mkdir -p $des_folder/Dynamic/Strace/
mkdir -p $des_folder/Features_files/
mkdir -p $des_folder/FlowDroid_outputs/
mkdir -p $des_folder/FlowDroid_processed/
mkdir -p $des_folder/samples/BW/
mkdir -p $des_folder/samples/MW/
mkdir -p $des_folder/invalid_apks/
mkdir -p $des_folder/VT_analysis/



# Loop from 0 to the length of the array


echo "============== START EVALUATE ================"

for i in $(seq 0 $((${#files[@]} - 1))); do

  # Clear the container stored in the system
  echo "Y" | docker system prune

  # Remove all output and start new files
  echo "REMOVING ALL OUTPUT (IF TRUE)..."
  temp_path="/home/virus/Desktop/TEST_APK"
  rm -dRf  $temp_path/*
  

  
  cp "${files[i]}" "/home/virus/Desktop/TEST_APK"
  
  # Start AndroPy
  echo "PROCESSING WITH ANDROPY ... ${file[i]}"
  docker run --volume=/home/virus/Desktop/TEST_APK:/apks alexmyg/andropytool -s /apks/ -vt b8732b29c7ce48431dc3bf42b300c98f5ba93ebbf3d470e4a5ed699f6e00a85b -all

  # Check the condition
  if [[ -d  "$temp_path/DroidBox_outputs" && -d  "$temp_path/Dynamic" && -d  "$temp_path/Features_files" && -d  "$temp_path/FlowDroid_outputs" && -d  "$temp_path/FlowDroid_processed" && -d  "$temp_path/VT_analysis" ]]
  then
    if [[ -z $(ls -A "$temp_path/DroidBox_outputs") || -z $(ls -A "$temp_path/Dynamic") || -z $(ls -A "$temp_path/Features_files") || -z $(ls -A "$temp_path/FlowDroid_outputs") || -z $(ls -A "$temp_path/FlowDroid_processed") || -z $(ls -A "$temp_path/VT_analysis") ]]
    then 
      echo "${files[i]}: FAILED - Empty folder detected !!!" >> result_checker
    else
      echo "${files[i]}: SUCCESSFUL !!!" >> result_checker
      cp -f $temp_path/DroidBox_outputs/* $des_folder/DroidBox_outputs/
      cp -f $temp_path/Dynamic/Droidbox/* $des_folder/Dynamic/Droidbox/
      cp -f $temp_path/Dynamic/Strace/* $des_folder/Dynamic/Strace/
      cp -f $temp_path/Features_files/* $des_folder/Features_files/
      cp -f $temp_path/FlowDroid_outputs/* $des_folder/FlowDroid_outputs/
      cp -f $temp_path/FlowDroid_processed/* $des_folder/FlowDroid_processed/
      cp -f $temp_path/VT_analysis/* $des_folder/VT_analysis/
      cp -f $temp_path/samples/BW/* $des_folder/samples/BW/
      cp -f $temp_path/samples/MW/* $des_folder/samples/MW/
      cp -f $temp_path/invalid_apks/* $des_folder/invalid_apks/  
    fi
  else
    echo "${files[i]}: FAILED - No folder detected !!!" >> result_checker
  fi
   

done
echo "============== FINISH EVALUATE ================"
